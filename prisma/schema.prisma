generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String         @id @default(cuid())
  email                   String         @unique
  phone                   String?        @unique
  password                String
  role                    UserRole
  emailVerified           Boolean        @default(false)
  phoneVerified           Boolean        @default(false)
  twoFactorEnabled        Boolean        @default(false)
  isActive                Boolean        @default(true)
  verificationToken       String?        @unique
  verificationTokenExpiry DateTime?
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  auditLogs               AuditLog[]
  doctor                  Doctor?
  notifications           Notification[]
  patient                 Patient?

  @@index([email])
  @@index([phone])
  @@index([verificationToken])
}

model Patient {
  id                String          @id @default(cuid())
  userId            String          @unique
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  gender            String
  bloodGroup        String?
  address           String?
  city              String?
  state             String?
  zipCode           String?
  emergencyContact  String?
  emergencyPhone    String?
  insuranceProvider String?
  insuranceNumber   String?
  allergies         String?
  chronicConditions String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  appointments      Appointment[]
  labReports        LabReport[]
  medicalRecords    MedicalRecord[]
  messages          Message[]
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  prescriptions     Prescription[]

  @@index([userId])
}

model Doctor {
  id              String               @id @default(cuid())
  userId          String               @unique
  firstName       String
  lastName        String
  specialization  String
  qualification   String
  experience      Int
  licenseNumber   String               @unique
  licenseVerified Boolean              @default(false)
  consultationFee Float
  about           String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  rating          Float                @default(0)
  totalReviews    Int                  @default(0)
  isAvailable     Boolean              @default(true)
  schedule        Json?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  appointments    Appointment[]
  user            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  availability    DoctorAvailability[]
  messages        Message[]
  prescriptions   Prescription[]
  reviews         Review[]

  @@index([userId])
  @@index([specialization])
  @@index([licenseNumber])
}

model DoctorAvailability {
  id           String   @id @default(cuid())
  doctorId     String
  dayOfWeek    Int
  startTime    String
  endTime      String
  slotDuration Int      @default(30)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  doctor       Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([dayOfWeek])
}

model Appointment {
  id              String            @id @default(cuid())
  patientId       String
  doctorId        String
  appointmentDate DateTime
  startTime       String
  endTime         String
  status          AppointmentStatus @default(PENDING)
  reason          String?
  notes           String?
  cancelReason    String?
  reminderSent    Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  doctor          Doctor            @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient         Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  prescriptions   Prescription[]

  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@index([status])
}

model MedicalRecord {
  id          String   @id @default(cuid())
  patientId   String
  title       String
  description String?
  recordType  String
  recordDate  DateTime
  fileUrl     String?
  fileName    String?
  fileSize    Int?
  uploadedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([recordDate])
}

model Prescription {
  id               String       @id @default(cuid())
  patientId        String
  doctorId         String
  appointmentId    String?
  diagnosis        String
  medications      Json
  notes            String?
  followUpDate     DateTime?
  prescriptionDate DateTime     @default(now())
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  appointment      Appointment? @relation(fields: [appointmentId], references: [id])
  doctor           Doctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient          Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentId])
  @@index([prescriptionDate])
}

model LabReport {
  id        String   @id @default(cuid())
  patientId String
  testName  String
  testDate  DateTime
  results   Json
  fileUrl   String?
  fileName  String?
  remarks   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  patient   Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([testDate])
}

model Message {
  id          String        @id @default(cuid())
  patientId   String
  doctorId    String
  senderId    String
  content     String
  messageType MessageType   @default(REGULAR)
  status      MessageStatus @default(SENT)
  fileUrl     String?
  fileName    String?
  isEmergency Boolean       @default(false)
  resolvedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  doctor      Doctor        @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient     Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([doctorId])
  @@index([senderId])
  @@index([isEmergency])
  @@index([createdAt])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  metadata  Json?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Review {
  id          String   @id @default(cuid())
  doctorId    String
  patientName String
  rating      Int
  comment     String?
  createdAt   DateTime @default(now())
  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([rating])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  resource   String
  resourceId String
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model SystemSettings {
  id                String   @id @default(cuid())
  siteName          String   @default("Patient Management System")
  supportEmail      String   @default("support@example.com")
  supportPhone      String   @default("+1234567890")
  enableRegistration Boolean @default(true)
  enableChat        Boolean  @default(true)
  maintenanceMode   Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum MessageType {
  REGULAR
  EMERGENCY
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum NotificationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  EMERGENCY_CHAT
  NEW_MESSAGE
  PRESCRIPTION_READY
  LAB_REPORT_READY
}
