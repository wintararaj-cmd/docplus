// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum MessageType {
  REGULAR
  EMERGENCY
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum NotificationType {
  APPOINTMENT_REMINDER
  APPOINTMENT_CONFIRMED
  APPOINTMENT_CANCELLED
  EMERGENCY_CHAT
  NEW_MESSAGE
  PRESCRIPTION_READY
  LAB_REPORT_READY
}

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  phone                 String?   @unique
  password              String
  role                  UserRole
  emailVerified         Boolean   @default(false)
  phoneVerified         Boolean   @default(false)
  twoFactorEnabled      Boolean   @default(false)
  isActive              Boolean   @default(true)
  verificationToken     String?   @unique
  verificationTokenExpiry DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  patient       Patient?
  doctor        Doctor?
  notifications Notification[]
  auditLogs     AuditLog[]
  
  @@index([email])
  @@index([phone])
  @@index([verificationToken])
}

model Patient {
  id                String   @id @default(cuid())
  userId            String   @unique
  firstName         String
  lastName          String
  dateOfBirth       DateTime
  gender            String
  bloodGroup        String?
  address           String?
  city              String?
  state             String?
  zipCode           String?
  emergencyContact  String?
  emergencyPhone    String?
  insuranceProvider String?
  insuranceNumber   String?
  allergies         String?
  chronicConditions String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments      Appointment[]
  medicalRecords    MedicalRecord[]
  prescriptions     Prescription[]
  labReports        LabReport[]
  messages          Message[]
  
  @@index([userId])
}

model Doctor {
  id                  String   @id @default(cuid())
  userId              String   @unique
  firstName           String
  lastName            String
  specialization      String
  qualification       String
  experience          Int      // years of experience
  licenseNumber       String   @unique
  licenseVerified     Boolean  @default(false)
  consultationFee     Float
  about               String?
  address             String?
  city                String?
  state               String?
  zipCode             String?
  rating              Float    @default(0)
  totalReviews        Int      @default(0)
  isAvailable         Boolean  @default(true)
  schedule            Json?    // Weekly schedule with availability
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments        Appointment[]
  availability        DoctorAvailability[]
  prescriptions       Prescription[]
  messages            Message[]
  reviews             Review[]
  
  @@index([userId])
  @@index([specialization])
  @@index([licenseNumber])
}

model DoctorAvailability {
  id          String   @id @default(cuid())
  doctorId    String
  dayOfWeek   Int      // 0-6 (Sunday-Saturday)
  startTime   String   // HH:mm format
  endTime     String   // HH:mm format
  slotDuration Int     @default(30) // minutes
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  doctor      Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  @@index([doctorId])
  @@index([dayOfWeek])
}

model Appointment {
  id              String            @id @default(cuid())
  patientId       String
  doctorId        String
  appointmentDate DateTime
  startTime       String            // HH:mm format
  endTime         String            // HH:mm format
  status          AppointmentStatus @default(PENDING)
  reason          String?
  notes           String?
  cancelReason    String?
  reminderSent    Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  patient         Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor          Doctor            @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  prescriptions   Prescription[]
  
  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@index([status])
}

model MedicalRecord {
  id            String   @id @default(cuid())
  patientId     String
  title         String
  description   String?
  recordType    String   // e.g., "Consultation", "Surgery", "Imaging", "Other"
  recordDate    DateTime
  fileUrl       String?
  fileName      String?
  fileSize      Int?
  uploadedBy    String?  // userId who uploaded
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([recordDate])
}

model Prescription {
  id            String   @id @default(cuid())
  patientId     String
  doctorId      String
  appointmentId String?
  diagnosis     String
  medications   Json     // Array of {name, dosage, frequency, duration, instructions}
  notes         String?
  followUpDate  DateTime?
  prescriptionDate DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor        Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  
  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentId])
  @@index([prescriptionDate])
}

model LabReport {
  id            String   @id @default(cuid())
  patientId     String
  testName      String
  testDate      DateTime
  results       Json     // Structured test results
  fileUrl       String?
  fileName      String?
  remarks       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([testDate])
}

model Message {
  id            String        @id @default(cuid())
  patientId     String
  doctorId      String
  senderId      String        // userId of sender
  content       String
  messageType   MessageType   @default(REGULAR)
  status        MessageStatus @default(SENT)
  fileUrl       String?
  fileName      String?
  isEmergency   Boolean       @default(false)
  resolvedAt    DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  patient       Patient       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor        Doctor        @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  @@index([patientId])
  @@index([doctorId])
  @@index([senderId])
  @@index([isEmergency])
  @@index([createdAt])
}

model Notification {
  id            String           @id @default(cuid())
  userId        String
  type          NotificationType
  title         String
  message       String
  isRead        Boolean          @default(false)
  metadata      Json?            // Additional data like appointmentId, etc.
  createdAt     DateTime         @default(now())
  
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Review {
  id            String   @id @default(cuid())
  doctorId      String
  patientName   String
  rating        Int      // 1-5
  comment       String?
  createdAt     DateTime @default(now())
  
  doctor        Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  
  @@index([doctorId])
  @@index([rating])
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String
  action        String   // e.g., "VIEW_MEDICAL_RECORD", "UPDATE_PRESCRIPTION"
  resource      String   // e.g., "MedicalRecord", "Prescription"
  resourceId    String
  metadata      Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
